{"name":"xhs","url":"https://pro.xiaohongshu.com","showName":"聚光自动发卡","appid":"com.xhspro.app","icon":"","iconRound":true,"state":true,"single":true,"injectJq":true,"tauriApi":false,"devbug":false,"version":"0.0.1","preview":"custom","platform":["1-1","1-2","2-1","2-2"],"width":1920,"height":1080,"desc":"","jsFile":[],"filterCss":"","customJs":"(function() {\n    'use strict';\n    \n    // ==================== 配置管理模块 ====================\n    class ConfigManager {\n        constructor() {\n            this.storagePrefix = 'xiaohongshu_auto_card_';\n            this.defaultConfig = {\n                enabled: true,\n                autoInterval: 5000, // 5秒检查一次红点\n                maxRetries: 3,\n                debug: true,\n                notifications: true,\n                randomDelay: true, // 是否启用随机延迟\n                minDelay: 1000,\n                maxDelay: 3000,\n                cardSelection: 'random', // 'random' or 'manual'\n                selectedCardIndex: 0, // 手动选择的名片索引\n                sentCount: 0 // 已发送名片次数\n            };\n        }\n        \n        getConfig(key) {\n            try {\n                const value = localStorage.getItem(this.storagePrefix + key);\n                if (value !== null) {\n                    return JSON.parse(value);\n                }\n                return this.defaultConfig[key];\n            } catch (error) {\n                console.error('读取配置失败:', error);\n                return this.defaultConfig[key];\n            }\n        }\n        \n        setConfig(key, value) {\n            try {\n                localStorage.setItem(this.storagePrefix + key, JSON.stringify(value));\n            } catch (error) {\n                console.error('保存配置失败:', error);\n            }\n        }\n        \n        resetConfig() {\n            try {\n                Object.keys(localStorage).forEach(key => {\n                    if (key.startsWith(this.storagePrefix)) {\n                        localStorage.removeItem(key);\n                    }\n                });\n            } catch (error) {\n                console.error('重置配置失败:', error);\n            }\n        }\n    }\n    \n    // ==================== 日志管理模块 ====================\n    class Logger {\n        constructor(debug = false) {\n            this.debug = debug;\n            this.prefix = '[小红书自动发名片]';\n        }\n        \n        log(message, ...args) {\n            if (this.debug) {\n                console.log(`${this.prefix} ${message}`, ...args);\n            }\n        }\n        \n        error(message, ...args) {\n            console.error(`${this.prefix} ERROR: ${message}`, ...args);\n        }\n        \n        warn(message, ...args) {\n            console.warn(`${this.prefix} WARN: ${message}`, ...args);\n        }\n        \n        info(message, ...args) {\n            console.info(`${this.prefix} INFO: ${message}`, ...args);\n        }\n    }\n    \n    // ==================== 通知管理模块 ====================\n    class NotificationManager {\n        constructor(enabled = true) {\n            this.enabled = enabled;\n            this.checkPermission();\n        }\n        \n        async checkPermission() {\n            if (!('Notification' in window)) {\n                console.warn('此浏览器不支持桌面通知');\n                this.enabled = false;\n                return;\n            }\n            \n            if (Notification.permission === 'default') {\n                const permission = await Notification.requestPermission();\n                if (permission !== 'granted') {\n                    this.enabled = false;\n                }\n            } else if (Notification.permission === 'denied') {\n                this.enabled = false;\n            }\n        }\n        \n        show(title, message, type = 'info') {\n            if (!this.enabled || Notification.permission !== 'granted') {\n                console.log(`通知: ${title} - ${message}`);\n                return;\n            }\n            \n            try {\n                const notification = new Notification(title, {\n                    body: message,\n                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyUzYuNDggMjIgMTIgMjIgMjIgMTcuNTIgMjIgMTJTMTcuNTIgMiAxMiAyWk0xMiAyMEM3LjU5IDIwIDQgMTYuNDEgNCAxMlM3LjU5IDQgMTIgNFMyMCA3LjU5IDIwIDEyUzE2LjQxIDIwIDEyIDIwWiIgZmlsbD0iIzMzNzNkYyIvPgo8L3N2Zz4K'\n                });\n                \n                setTimeout(() => {\n                    notification.close();\n                }, 3000);\n            } catch (error) {\n                console.error('通知显示失败:', error);\n            }\n        }\n        \n        success(message) {\n            this.show('成功', message, 'success');\n        }\n        \n        error(message) {\n            this.show('错误', message, 'error');\n        }\n        \n        warning(message) {\n            this.show('警告', message, 'warning');\n        }\n        \n        info(message) {\n            this.show('信息', message, 'info');\n        }\n    }\n    \n    // ==================== 工具函数模块 ====================\n    class Utils {\n        static sleep(ms) {\n            return new Promise(resolve => setTimeout(resolve, ms));\n        }\n        \n        static waitForElement(selector, timeout = 10000) {\n            return new Promise((resolve, reject) => {\n                const startTime = Date.now();\n                \n                const checkElement = () => {\n                    const element = document.querySelector(selector);\n                    if (element) {\n                        resolve(element);\n                        return;\n                    }\n                    \n                    if (Date.now() - startTime > timeout) {\n                        reject(new Error(`Element ${selector} not found within timeout`));\n                        return;\n                    }\n                    \n                    setTimeout(checkElement, 100);\n                };\n                \n                checkElement();\n            });\n        }\n        \n        static getRandomDelay(min = 1000, max = 3000) {\n            return Math.floor(Math.random() * (max - min + 1)) + min;\n        }\n        \n        static formatTime(date = new Date()) {\n            return date.toLocaleString('zh-CN', {\n                year: 'numeric',\n                month: '2-digit',\n                day: '2-digit',\n                hour: '2-digit',\n                minute: '2-digit',\n                second: '2-digit'\n            });\n        }\n        \n        static safeClick(element) {\n            if (!element) {\n                throw new Error('元素不存在，无法点击');\n            }\n            \n            try {\n                // 尝试直接点击\n                element.click();\n                return true;\n            } catch (error) {\n                // 如果直接点击失败，尝试使用事件分发\n                try {\n                    const clickEvent = new MouseEvent('click', {\n                        bubbles: true,\n                        cancelable: true\n                    });\n                    element.dispatchEvent(clickEvent);\n                    return true;\n                } catch (eventError) {\n                    // 如果事件分发也失败，使用最基本的方式\n                    try {\n                        element.dispatchEvent(new Event('click', {bubbles: true}));\n                        return true;\n                    } catch (basicError) {\n                        throw new Error(`点击失败: ${basicError.message}`);\n                    }\n                }\n            }\n        }\n    }\n    \n    // ==================== 页面检测模块 ====================\n    class PageDetector {\n        constructor() {\n            this.targetUrlPattern = /^https:\\/\\/pro\\.xiaohongshu\\.com\\/im\\/multiCustomerService/;\n        }\n        \n        detectCurrentPage() {\n            const url = window.location.href;\n            \n            // 检测小红书专业版多客服页面\n            if (this.targetUrlPattern.test(url)) {\n                return 'multiCustomerService';\n            }\n            \n            return 'unknown';\n        }\n        \n        isTargetPage() {\n            return this.detectCurrentPage() === 'multiCustomerService';\n        }\n        \n        isTargetUrl() {\n            return this.targetUrlPattern.test(window.location.href);\n        }\n    }\n    \n    // ==================== 名片操作模块 ====================\n    class CardOperations {\n        constructor(logger, notificationManager, uiManager = null, configManager = null) {\n            this.logger = logger;\n            this.notification = notificationManager;\n            this.ui = uiManager;\n            this.config = configManager;\n            this.isRunning = false;\n            this.retryCount = 0;\n            this.maxRetries = 3;\n        }\n        \n        setUIManager(uiManager) {\n            this.ui = uiManager;\n        }\n        \n        setConfigManager(configManager) {\n            this.config = configManager;\n        }\n        \n        async autoSendCard() {\n            if (this.isRunning) {\n                this.logger.warn('自动发名片已在运行中');\n                this.ui && this.ui.updateStatus('运行中...');\n                return;\n            }\n            \n            this.isRunning = true;\n            this.logger.info('开始自动发名片');\n            this.ui && this.ui.updateStatus('正在发送名片...');\n            \n            try {\n                await this.performCardAction();\n                \n                this.ui && this.ui.updateStatus('发送成功');\n                this.ui && this.ui.updateSentCount();\n                this.retryCount = 0;\n            } catch (error) {\n                this.logger.error('自动发名片失败:', error);\n                this.ui && this.ui.updateStatus(`发送失败: ${error.message}`);\n                this.handleError(error);\n            } finally {\n                this.isRunning = false;\n            }\n        }\n        \n        async performCardAction() {\n            this.logger.log('开始执行自动发名片操作...');\n            \n            // 步骤1: 检查是否有红点（未回复消息）\n            const redDots = document.querySelectorAll(\"div.item-main > div.item-avatar > span > span\");\n            if (redDots.length === 0) {\n                this.logger.log('未找到红点元素，暂无未回复消息');\n                return;\n            }\n            \n            this.logger.log(`发现 ${redDots.length} 个未回复消息，开始处理第一个`);\n            \n            // 步骤2: 点击第一个红点对应的头像\n            const firstAvatar = redDots[0].parentElement;\n            if (!firstAvatar) {\n                throw new Error('无法找到头像元素');\n            }\n            \n            this.logger.log('点击头像...');\n            Utils.safeClick(firstAvatar);\n            await Utils.sleep(Utils.getRandomDelay(1000, 2000));\n            \n            // 步骤3: 点击获客工具\n            this.logger.log('查找获客工具按钮...');\n            const customerToolSvg = document.querySelector(\"#replyBox > div.reply-box > div.tool-list > div > div:nth-child(6) > svg\");\n            if (!customerToolSvg) {\n                throw new Error('未找到获客工具按钮');\n            }\n            \n            this.logger.log('点击获客工具...');\n            Utils.safeClick(customerToolSvg);\n            await Utils.sleep(Utils.getRandomDelay(1000, 2000));\n            \n            // 步骤4: 点击名片tab\n            this.logger.log('查找名片tab...');\n            const cardTab = document.querySelector(\"#rightPanel > div.right-side.right-side_pro > div > div.tabs > div.d-segment > div > div:nth-child(2)\");\n            if (!cardTab) {\n                throw new Error('未找到名片tab');\n            }\n            \n            this.logger.log('点击名片tab...');\n            Utils.safeClick(cardTab);\n            await Utils.sleep(Utils.getRandomDelay(1000, 2000));\n            \n            // 步骤5: 选择名片发送\n            this.logger.log('查找名片列表...');\n            const cardContainer = document.querySelector(\"#rightPanel > div.right-side.right-side_pro > div > div.page-container > div:nth-child(2) > div\");\n            if (!cardContainer || cardContainer.children.length === 0) {\n                throw new Error('未找到名片列表或名片列表为空');\n            }\n            \n            // 根据配置选择名片\n            const cardSelection = this.config.getConfig('cardSelection');\n            let selectedIndex;\n            let selectedCard;\n            \n            if (cardSelection === 'manual') {\n                selectedIndex = this.config.getConfig('selectedCardIndex');\n                if (selectedIndex >= cardContainer.children.length) {\n                    selectedIndex = 0; // 如果指定的索引超出范围，回到第一个\n                }\n                selectedCard = cardContainer.children[selectedIndex];\n                this.logger.log(`手动选择第 ${selectedIndex + 1} 个名片（共 ${cardContainer.children.length} 个）`);\n            } else {\n                // 随机选择\n                selectedIndex = Math.floor(Math.random() * cardContainer.children.length);\n                selectedCard = cardContainer.children[selectedIndex];\n                this.logger.log(`随机选择第 ${selectedIndex + 1} 个名片（共 ${cardContainer.children.length} 个）`);\n            }\n            \n            // 找到发送按钮并点击\n            const sendButton = selectedCard.children[0].children[0].children[0].children[1];\n            if (!sendButton) {\n                throw new Error('未找到发送按钮');\n            }\n            \n            this.logger.log('点击发送按钮...');\n            Utils.safeClick(sendButton);\n            await Utils.sleep(Utils.getRandomDelay(500, 1000));\n            \n            // 增加发送计数\n            const currentCount = this.config.getConfig('sentCount') || 0;\n            this.config.setConfig('sentCount', currentCount + 1);\n            \n            this.logger.log('自动发名片操作完成');\n        }\n        \n        getCardList() {\n            const cardContainer = document.querySelector(\"#rightPanel > div.right-side.right-side_pro > div > div.page-container > div:nth-child(2) > div\");\n            if (!cardContainer || cardContainer.children.length === 0) {\n                return [];\n            }\n            \n            const cards = [];\n            for (let i = 0; i < cardContainer.children.length; i++) {\n                const card = cardContainer.children[i];\n                try {\n                    // 尝试获取名片的文本内容\n                    const cardText = card.textContent || card.innerText || `名片${i + 1}`;\n                    cards.push({\n                        index: i,\n                        text: cardText.trim().substring(0, 50) // 限制文本长度\n                    });\n                } catch (error) {\n                    cards.push({\n                        index: i,\n                        text: `名片${i + 1}`\n                    });\n                }\n            }\n            \n            return cards;\n        }\n        \n        handleError(error) {\n            this.retryCount++;\n            \n            if (this.retryCount <= this.maxRetries) {\n                this.logger.warn(`发名片失败，将进行第${this.retryCount}次重试`);\n                this.notification.warning(`发名片失败，正在重试 (${this.retryCount}/${this.maxRetries})`);\n                \n                setTimeout(() => {\n                    this.autoSendCard();\n                }, Utils.getRandomDelay(3000, 5000));\n            } else {\n                this.logger.error('达到最大重试次数，停止自动发名片');\n                this.notification.error('自动发名片失败，请检查页面状态');\n                this.retryCount = 0;\n            }\n        }\n    }\n    \n    // ==================== UI界面模块 ====================\n    class UIManager {\n        constructor(configManager, cardOperations) {\n            this.config = configManager;\n            this.cardOps = cardOperations;\n            this.panel = null;\n            this.logger = new Logger(configManager.getConfig('debug'));\n        }\n        \n        createControlPanel() {\n            this.logger.log('创建控制面板...');\n            \n            // 检查是否已存在面板\n            const existingPanel = document.getElementById('xiaohongshu-auto-card-panel');\n            if (existingPanel) {\n                existingPanel.remove();\n            }\n            \n            // 创建控制面板容器\n            this.panel = document.createElement('div');\n            this.panel.id = 'xiaohongshu-auto-card-panel';\n            this.panel.innerHTML = `\n                <div style=\"\n                    position: fixed;\n                    top: 10px;\n                    right: 10px;\n                    width: 350px;\n                    background: #fff;\n                    border: 1px solid #ddd;\n                    border-radius: 8px;\n                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n                    z-index: 9999;\n                    font-family: Arial, sans-serif;\n                    font-size: 14px;\n                \">\n                    <div style=\"\n                        background: #f5f5f5;\n                        padding: 10px;\n                        border-bottom: 1px solid #ddd;\n                        border-radius: 8px 8px 0 0;\n                        font-weight: bold;\n                        display: flex;\n                        justify-content: space-between;\n                        align-items: center;\n                    \">\n                        <span>极光小红书自动发名片</span>\n                        <div style=\"display: flex; align-items: center; gap: 10px;\">\n                            <span id=\"sentCountDisplay\" style=\"font-size: 12px; color: #666;\">\n                                已发送: ${this.config.getConfig('sentCount') || 0}\n                            </span>\n                            <button id=\"togglePanel\" style=\"\n                                background: #666;\n                                color: white;\n                                border: none;\n                                padding: 4px 8px;\n                                border-radius: 4px;\n                                cursor: pointer;\n                                font-size: 12px;\n                            \">最小化</button>\n                        </div>\n                    </div>\n                    <div id=\"panelContent\" style=\"padding: 15px;\">\n                        <div style=\"margin-bottom: 10px;\">\n                            <label style=\"display: block; margin-bottom: 5px;\">\n                                <input type=\"checkbox\" id=\"autoEnabled\" ${this.config.getConfig('enabled') ? 'checked' : ''}> \n                                启用自动发名片\n                            </label>\n                        </div>\n                        <div style=\"margin-bottom: 10px;\">\n                            <label style=\"display: block; margin-bottom: 5px;\">\n                                检查间隔（秒）：\n                                <input type=\"number\" id=\"autoInterval\" value=\"${this.config.getConfig('autoInterval') / 1000}\" \n                                       min=\"1\" max=\"60\" style=\"width: 60px; margin-left: 5px;\">\n                            </label>\n                        </div>\n                        <div style=\"margin-bottom: 10px;\">\n                            <label style=\"display: block; margin-bottom: 5px;\">\n                                名片选择模式：\n                                <select id=\"cardSelection\" style=\"margin-left: 5px;\">\n                                    <option value=\"random\" ${this.config.getConfig('cardSelection') === 'random' ? 'selected' : ''}>随机选择</option>\n                                    <option value=\"manual\" ${this.config.getConfig('cardSelection') === 'manual' ? 'selected' : ''}>手动指定</option>\n                                </select>\n                            </label>\n                        </div>\n                        <div id=\"cardListContainer\" style=\"margin-bottom: 10px; display: ${this.config.getConfig('cardSelection') === 'manual' ? 'block' : 'none'};\">\n                            <label style=\"display: block; margin-bottom: 5px;\">选择名片：</label>\n                            <select id=\"cardList\" style=\"width: 100%; margin-bottom: 5px;\">\n                                <option value=\"0\">请先刷新名片列表</option>\n                            </select>\n                            <button id=\"refreshCardList\" style=\"\n                                background: #1890ff;\n                                color: white;\n                                border: none;\n                                padding: 4px 8px;\n                                border-radius: 4px;\n                                cursor: pointer;\n                                font-size: 12px;\n                            \">刷新名片列表</button>\n                        </div>\n                        <div style=\"margin-bottom: 10px;\">\n                            <button id=\"manualSend\" style=\"\n                                background: #ff2442;\n                                color: white;\n                                border: none;\n                                padding: 8px 16px;\n                                border-radius: 4px;\n                                cursor: pointer;\n                                margin-right: 10px;\n                            \">手动发送</button>\n                            <button id=\"resetCount\" style=\"\n                                background: #f5222d;\n                                color: white;\n                                border: none;\n                                padding: 8px 16px;\n                                border-radius: 4px;\n                                cursor: pointer;\n                                font-size: 12px;\n                            \">重置计数</button>\n                        </div>\n                        <div id=\"statusDisplay\" style=\"\n                            background: #f9f9f9;\n                            padding: 8px;\n                            border-radius: 4px;\n                            font-size: 12px;\n                            color: #666;\n                        \">\n                            状态：等待中...\n                        </div>\n                    </div>\n                </div>\n            `;\n            \n            // 添加到页面\n            document.body.appendChild(this.panel);\n            \n            // 绑定事件\n            this.bindEvents();\n            \n            this.logger.log('控制面板创建完成');\n        }\n        \n        bindEvents() {\n            // 启用/禁用自动发名片\n            const enabledCheckbox = document.getElementById('autoEnabled');\n            if (enabledCheckbox) {\n                enabledCheckbox.addEventListener('change', (e) => {\n                    this.config.setConfig('enabled', e.target.checked);\n                    this.logger.log(`自动发名片已${e.target.checked ? '启用' : '禁用'}`);\n                    // 重新启动自动模式以应用配置变更\n                    if (this.mainApp) {\n                        setTimeout(() => {\n                            this.mainApp.startAutoMode();\n                        }, 100);\n                    }\n                });\n            }\n            \n            // 修改检查间隔\n            const intervalInput = document.getElementById('autoInterval');\n            if (intervalInput) {\n                intervalInput.addEventListener('change', (e) => {\n                    const newInterval = parseInt(e.target.value) * 1000;\n                    this.config.setConfig('autoInterval', newInterval);\n                    this.logger.log(`检查间隔已修改为 ${e.target.value} 秒`);\n                    // 重新启动自动模式以应用新的间隔\n                    if (this.mainApp && this.config.getConfig('enabled')) {\n                        setTimeout(() => {\n                            this.mainApp.startAutoMode();\n                        }, 100);\n                    }\n                });\n            }\n            \n            // 名片选择模式\n            const cardSelectionSelect = document.getElementById('cardSelection');\n            if (cardSelectionSelect) {\n                cardSelectionSelect.addEventListener('change', (e) => {\n                    this.config.setConfig('cardSelection', e.target.value);\n                    this.logger.log(`名片选择模式已修改为 ${e.target.value === 'random' ? '随机选择' : '手动指定'}`);\n                    \n                    // 显示/隐藏名片列表\n                    const cardListContainer = document.getElementById('cardListContainer');\n                    if (cardListContainer) {\n                        cardListContainer.style.display = e.target.value === 'manual' ? 'block' : 'none';\n                    }\n                });\n            }\n            \n            // 名片列表选择\n            const cardListSelect = document.getElementById('cardList');\n            if (cardListSelect) {\n                cardListSelect.addEventListener('change', (e) => {\n                    this.config.setConfig('selectedCardIndex', parseInt(e.target.value));\n                    this.logger.log(`已选择第 ${parseInt(e.target.value) + 1} 个名片`);\n                });\n            }\n            \n            // 刷新名片列表\n            const refreshCardListBtn = document.getElementById('refreshCardList');\n            if (refreshCardListBtn) {\n                refreshCardListBtn.addEventListener('click', () => {\n                    this.refreshCardList();\n                });\n            }\n            \n            // 手动发送按钮\n            const manualSendBtn = document.getElementById('manualSend');\n            if (manualSendBtn) {\n                manualSendBtn.addEventListener('click', () => {\n                    this.cardOps.autoSendCard();\n                });\n            }\n            \n            // 重置计数按钮\n            const resetCountBtn = document.getElementById('resetCount');\n            if (resetCountBtn) {\n                resetCountBtn.addEventListener('click', () => {\n                    this.config.setConfig('sentCount', 0);\n                    this.updateSentCount();\n                    this.logger.log('已重置发送计数');\n                });\n            }\n            \n            // 最小化按钮\n            const toggleBtn = document.getElementById('togglePanel');\n            if (toggleBtn) {\n                toggleBtn.addEventListener('click', () => {\n                    const content = document.getElementById('panelContent');\n                    if (content) {\n                        const isCurrentlyVisible = content.style.display !== 'none';\n                        \n                        if (isCurrentlyVisible) {\n                            content.style.display = 'none';\n                            toggleBtn.textContent = '展开';\n                        } else {\n                            content.style.display = 'block';\n                            toggleBtn.textContent = '最小化';\n                        }\n                    }\n                });\n            }\n        }\n        \n        refreshCardList() {\n            const cardList = this.cardOps.getCardList();\n            const cardListSelect = document.getElementById('cardList');\n            \n            // 清空现有选项\n            cardListSelect.innerHTML = '';\n            \n            if (cardList.length === 0) {\n                cardListSelect.innerHTML = '<option value=\"0\">未找到名片或需要先打开名片页面</option>';\n                return;\n            }\n            \n            // 添加新选项\n            cardList.forEach(card => {\n                const option = document.createElement('option');\n                option.value = card.index;\n                option.textContent = `${card.index + 1}. ${card.text}`;\n                if (card.index === this.config.getConfig('selectedCardIndex')) {\n                    option.selected = true;\n                }\n                cardListSelect.appendChild(option);\n            });\n            \n            this.logger.log(`已刷新名片列表，共 ${cardList.length} 个名片`);\n        }\n        \n        updateSentCount() {\n            const sentCountDisplay = document.getElementById('sentCountDisplay');\n            if (sentCountDisplay) {\n                const count = this.config.getConfig('sentCount') || 0;\n                sentCountDisplay.textContent = `已发送: ${count}`;\n            }\n        }\n        \n        showPanel() {\n            if (this.panel) {\n                this.panel.style.display = 'block';\n            }\n        }\n        \n        hidePanel() {\n            if (this.panel) {\n                this.panel.style.display = 'none';\n            }\n        }\n        \n        updateStatus(status) {\n            this.logger.log('更新状态:', status);\n            const statusDisplay = document.getElementById('statusDisplay');\n            if (statusDisplay) {\n                const timestamp = Utils.formatTime();\n                statusDisplay.textContent = `状态：${status} (${timestamp})`;\n            }\n        }\n        \n        destroy() {\n            if (this.panel) {\n                this.panel.remove();\n                this.panel = null;\n            }\n        }\n    }\n    \n    // ==================== 主应用模块 ====================\n    class JuguangAutoCard {\n        constructor() {\n            this.config = new ConfigManager();\n            this.logger = new Logger(this.config.getConfig('debug'));\n            this.notification = new NotificationManager(this.config.getConfig('notifications'));\n            this.pageDetector = new PageDetector();\n            this.cardOps = new CardOperations(this.logger, this.notification, null, this.config);\n            this.ui = null;\n            \n            this.isInitialized = false;\n            this.intervalId = null;\n            this.urlCheckInterval = null;\n        }\n        \n        async init() {\n            if (this.isInitialized) {\n                this.logger.warn('应用已经初始化');\n                return;\n            }\n            \n            this.logger.info('初始化小红书专业版自动发名片脚本...');\n            \n            try {\n                await this.waitForPageLoad();\n                await this.setupUI();\n                await this.startAutoMode();\n                \n                this.isInitialized = true;\n                this.logger.info('脚本初始化完成');\n                this.notification.success('小红书专业版自动发名片脚本已启动');\n            } catch (error) {\n                this.logger.error('初始化失败:', error);\n                this.notification.error('脚本初始化失败');\n            }\n        }\n        \n        async waitForPageLoad() {\n            return new Promise((resolve) => {\n                if (document.readyState === 'complete') {\n                    resolve();\n                } else {\n                    window.addEventListener('load', resolve);\n                }\n            });\n        }\n        \n        async setupUI() {\n            this.ui = new UIManager(this.config, this.cardOps);\n            this.cardOps.setUIManager(this.ui);\n            this.ui.mainApp = this;\n            \n            this.ui.createControlPanel();\n            this.logger.log('UI设置完成');\n        }\n        \n        async startAutoMode() {\n            // 先停止之前的定时器\n            this.stop();\n            \n            const enabled = this.config.getConfig('enabled');\n            this.logger.log(`检查自动模式状态: ${enabled ? '启用' : '禁用'}`);\n            \n            if (!enabled) {\n                this.logger.log('自动模式已禁用');\n                this.ui && this.ui.updateStatus('自动模式已禁用');\n                return;\n            }\n            \n            if (!this.pageDetector.isTargetPage()) {\n                this.logger.log('当前页面不是目标页面，跳过自动模式');\n                this.ui && this.ui.updateStatus('当前页面不是目标页面');\n                return;\n            }\n            \n            const interval = this.config.getConfig('autoInterval');\n            this.intervalId = setInterval(() => {\n                // 每次执行前再次检查是否启用和是否在目标页面\n                if (this.config.getConfig('enabled') && this.pageDetector.isTargetPage()) {\n                    this.cardOps.autoSendCard();\n                } else if (!this.pageDetector.isTargetPage()) {\n                    this.logger.log('页面已跳转，停止自动模式');\n                    this.stop();\n                } else {\n                    this.logger.log('检测到自动模式被禁用，停止定时器');\n                    this.stop();\n                }\n            }, interval);\n            \n            this.logger.info(`自动模式已启动，间隔: ${interval}ms`);\n            this.ui && this.ui.updateStatus(`自动模式运行中 (${interval/1000}s间隔)`);\n        }\n        \n        stop() {\n            if (this.intervalId) {\n                clearInterval(this.intervalId);\n                this.intervalId = null;\n            }\n            \n            this.logger.info('脚本已停止');\n            this.ui && this.ui.updateStatus('已停止');\n        }\n        \n        destroy() {\n            this.stop();\n            if (this.urlCheckInterval) {\n                clearInterval(this.urlCheckInterval);\n                this.urlCheckInterval = null;\n            }\n            if (this.ui) {\n                this.ui.destroy();\n                this.ui = null;\n            }\n            this.isInitialized = false;\n            this.logger.info('脚本已销毁');\n        }\n        \n        restart() {\n            this.destroy();\n            setTimeout(() => {\n                this.init();\n            }, 1000);\n        }\n    }\n    \n    // ==================== URL监听器 ====================\n    class URLWatcher {\n        constructor() {\n            this.pageDetector = new PageDetector();\n            this.app = null;\n            this.logger = new Logger(true);\n            this.currentUrl = window.location.href;\n            this.checkInterval = null;\n        }\n        \n        start() {\n            this.logger.info('开始URL监听...');\n            \n            // 立即检查当前URL\n            this.checkURL();\n            \n            // 定期检查URL变化（处理SPA路由）\n            this.checkInterval = setInterval(() => {\n                this.checkURL();\n            }, 1000); // 每秒检查一次\n            \n            // 监听popstate事件（浏览器前进后退）\n            window.addEventListener('popstate', () => {\n                setTimeout(() => URLWatcher.instance.checkURL(), 100);\n            });\n            \n            // 监听pushstate和replacestate（程序化导航）\n            this.overrideHistoryMethods();\n        }\n        \n        overrideHistoryMethods() {\n            const originalPushState = history.pushState;\n            const originalReplaceState = history.replaceState;\n            \n            history.pushState = function(...args) {\n                originalPushState.apply(this, args);\n                setTimeout(() => URLWatcher.instance.checkURL(), 100);\n            };\n            \n            history.replaceState = function(...args) {\n                originalReplaceState.apply(this, args);\n                setTimeout(() => URLWatcher.instance.checkURL(), 100);\n            };\n        }\n        \n        checkURL() {\n            const newUrl = window.location.href;\n            \n            if (newUrl !== this.currentUrl) {\n                this.logger.log(`URL变化: ${this.currentUrl} -> ${newUrl}`);\n                this.currentUrl = newUrl;\n                this.handleUrlChange();\n            } else if (this.pageDetector.isTargetUrl() && !this.app) {\n                // URL没变但是目标页面还未初始化\n                this.handleUrlChange();\n            }\n        }\n        \n        handleUrlChange() {\n            if (this.pageDetector.isTargetUrl()) {\n                if (!this.app) {\n                    this.logger.info('进入目标页面，初始化脚本...');\n                    this.app = new JuguangAutoCard();\n                    // 等待页面稳定后初始化\n                    setTimeout(() => {\n                        this.app.init();\n                    }, 2000);\n                }\n            } else {\n                if (this.app) {\n                    this.logger.info('离开目标页面，销毁脚本...');\n                    this.app.destroy();\n                    this.app = null;\n                }\n            }\n        }\n        \n        stop() {\n            if (this.checkInterval) {\n                clearInterval(this.checkInterval);\n                this.checkInterval = null;\n            }\n            \n            if (this.app) {\n                this.app.destroy();\n                this.app = null;\n            }\n            \n            this.logger.info('URL监听已停止');\n        }\n    }\n    \n    // ==================== 脚本入口 ====================\n    // 创建全局URL监听器实例\n    URLWatcher.instance = new URLWatcher();\n    \n    // 等待DOM加载完成后启动URL监听\n    if (document.readyState === 'loading') {\n        document.addEventListener('DOMContentLoaded', () => {\n            URLWatcher.instance.start();\n        });\n    } else {\n        URLWatcher.instance.start();\n    }\n    \n    // 暴露到全局作用域（用于调试）\n    window.JuguangAutoCard = JuguangAutoCard;\n    window.URLWatcher = URLWatcher;\n    \n    // 页面卸载时清理\n    window.addEventListener('beforeunload', () => {\n        URLWatcher.instance.stop();\n    });\n    \n})(); \n\n// very important, if you don't know what it is, don't touch it\n// 非常重要，不懂代码不要动，这里可以解决80%的问题，也可以生产1000+的bug\nconst hookClick = (e) => {\n    const origin = e.target.closest('a')\n    const isBaseTargetBlank = document.querySelector(\n        'head base[target=\"_blank\"]'\n    )\n    console.log('origin', origin, isBaseTargetBlank)\n    if (\n        (origin && origin.href && origin.target === '_blank') ||\n        (origin && origin.href && isBaseTargetBlank)\n    ) {\n        e.preventDefault()\n        console.log('handle origin', origin)\n        location.href = origin.href\n    } else {\n        console.log('not handle origin', origin)\n    }\n}\n\nwindow.open = function (url, target, features) {\n    console.log('open', url, target, features)\n    location.href = url\n}\n\ndocument.addEventListener('click', hookClick, { capture: true })\n","isHtml":false,"htmlPath":"","htmlFiles":[],"more":{"windows":{"label":"","title":"聚光自动发卡","url":"https://pro.xiaohongshu.com","userAgent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36","width":1920,"height":1080,"theme":null,"resizable":false,"fullscreen":false,"maximized":false,"minWidth":400,"minHeight":300,"maxWidth":1920,"maxHeight":1080,"decorations":true,"transparent":false,"titleBarStyle":"Visible","visible":true,"focus":true,"closable":true,"minimizable":true,"maximizable":true,"alwaysOnTop":false,"alwaysOnBottom":false,"center":false,"skipTaskbar":false,"tabbingIdentifier":null,"parent":null,"dragDropEnabled":true,"browserExtensionsEnabled":false,"devtools":true,"contentProtected":true,"hiddenTitle":false,"incognito":false,"proxyUrl":null,"useHttpsScheme":false,"zoomHotkeysEnabled":false,"acceptFirstMouse":false,"create":false}},"phone":{"safeArea":{"top":0,"bottom":0,"left":0,"right":0},"header":{"show":false,"title":"","backgroundColor":"","color":"","fontSize":16,"fontWeight":"bold","loading":false,"toolBar":false,"toolBarBackgroundColor":"","toolBarColor":"","toolBarFontSize":16,"toolBarFontWeight":"bold"},"siderMenu":{"show":false,"width":0,"backgroundColor":"","color":"","fontSize":16,"fontWeight":"bold","title":"","titleColor":"","titleFontSize":16,"titleFontWeight":"bold"},"tabBar":{"show":false,"backgroundColor":"","color":"","activeColor":"","fontSize":16,"fontWeight":"bold","tabBarItem":[]},"webview":{"userAgent":"","javaScriptEnabled":true,"domStorageEnabled":true,"allowFileAccess":true,"loadWithOverviewMode":true,"setSupportZoom":true,"clearCache":true}},"ios":{"name":"xhs","showName":"聚光自动发卡","version":"0.0.1","webUrl":"https://pro.xiaohongshu.com","id":"com.xhspro.app.ios","icon":"./app-icon.png","desc":"Package for personal use only, please do not use for commercial purposes（打包仅限个人使用，请勿传播或商业用途）","pubBody":"Package for personal use only, please do not use for commercial purposes（打包仅限个人使用，请勿传播或商业用途）","isHtml":false,"debug":false},"android":{"name":"xhs","showName":"聚光自动发卡","version":"0.0.1","webUrl":"https://pro.xiaohongshu.com","id":"com.xhspro.app.android","icon":"./app-icon.png","input":"./app-icon.png","output":"./res","rounded":true,"copyTo":"./app/src/main/res","androidResDir":"./app/src/main/res","desc":"Package for personal use only, please do not use for commercial purposes（打包仅限个人使用，请勿传播或商业用途）","pubBody":"Package for personal use only, please do not use for commercial purposes（打包仅限个人使用，请勿传播或商业用途）","isHtml":false,"debug":false},"desktop":{"name":"xhs","showName":"聚光自动发卡","version":"0.0.1","id":"com.xhspro.app.desktop","desc":"Package for personal use only, please do not use for commercial purposes（打包仅限个人使用，请勿传播或商业用途，否则后果自负）","webUrl":"https://pro.xiaohongshu.com","iconPath":"../app-icon.png","inputPath":"../app-icon.png","tempPath":"./processed-image.png","icnsPath":"../src-tauri/icons/icon.icns","pubBody":"Package for personal use only, please do not use for commercial purposes（打包仅限个人使用，请勿传播或商业用途，否则后果自负）","isHtml":false,"single":false,"state":true,"injectJq":false,"tauriApi":false,"buildMethod":"cloud","debug":false}}